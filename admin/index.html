<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Trendeals Admin</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root {
  --purple: #8e44ad;
  --bg: #faf6fb;
  --card: #ffffff;
  --text: #222;
}

/* RESET */
* { box-sizing: border-box; margin: 0; padding: 0; font-family: Arial, sans-serif; }

body {
  background: var(--bg);
  color: var(--text);
}

/* HEADER */
.header {
  height: 60px;
  background: #fff;
  display: flex;
  align-items: center;
  padding: 0 20px;
  justify-content: space-between;
  box-shadow: 0 2px 10px rgba(0,0,0,.05);
}

.logo {
  font-size: 22px;
  font-weight: 800;
}
.logo span { color: var(--purple); }

/* HAMBURGER */
.hamburger {
  font-size: 26px;
  cursor: pointer;
}

/* SIDEBAR */
.sidebar {
  position: fixed;
  right: -260px;
  top: 0;
  width: 260px;
  height: 100%;
  background: #fff;
  box-shadow: -5px 0 15px rgba(0,0,0,.1);
  padding: 20px;
  transition: .3s;
  z-index: 1001;
}
.sidebar.active { right: 0; }

.sidebar h3 { margin-bottom: 20px; }
.sidebar button {
  width: 100%;
  padding: 12px;
  background: #eee;
  border: none;
  border-radius: 8px;
  cursor: pointer;
}

/* OVERLAY */
.overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.4);
  display: none;
  z-index: 1000;
}
.overlay.active { display: block; }

/* MAIN */
.container {
  padding: 30px;
}

.top-bar {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.add-btn {
  background: var(--purple);
  color: #fff;
  border: none;
  padding: 12px 18px;
  border-radius: 10px;
  cursor: pointer;
  font-size: 15px;
}

/* PRODUCTS */
.products {
  margin-top: 25px;
  display: grid;
  grid-template-columns: repeat(auto-fill,minmax(220px,1fr));
  gap: 20px;
}

.card {
  background: var(--card);
  border-radius: 14px;
  padding: 12px;
  box-shadow: 0 8px 20px rgba(0,0,0,.06);
}

.card img {
  width: 100%;
  height: 150px;
  object-fit: cover;
  border-radius: 10px;
}

.card h4 { margin: 10px 0 5px; }
.card p { font-size: 14px; }

.card .actions {
  display: flex;
  gap: 8px;
  margin-top: 10px;
}
.card button {
  flex: 1;
  padding: 8px;
  border-radius: 8px;
  border: none;
  cursor: pointer;
}
.edit { background: #eee; }
.del { background: #ffdddd; }

/* MODAL */
.modal {
  position: fixed;
  inset: 0;
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 1002;
}
.modal.active { display: flex; }

.modal-box {
  background: #fff;
  width: 420px;
  max-height: 90vh;
  border-radius: 16px;
  padding: 20px;
  overflow-y: auto;
}

.modal-box h3 {
  margin-bottom: 15px;
}

.modal-box input {
  width: 100%;
  padding: 10px;
  margin-bottom: 10px;
}

.modal-box label {
  font-size: 14px;
  margin-top: 10px;
  display: block;
}

/* IMAGE PREVIEW */
.preview {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
  margin: 10px 0;
}
.preview div {
  position: relative;
}
.preview img {
  width: 80px;
  height: 80px;
  object-fit: cover;
  border-radius: 8px;
}
.preview span {
  position: absolute;
  top: -6px;
  right: -6px;
  background: red;
  color: #fff;
  font-size: 12px;
  border-radius: 50%;
  width: 18px;
  height: 18px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
}

.save-btn {
  background: var(--purple);
  color: #fff;
  border: none;
  width: 100%;
  padding: 12px;
  border-radius: 10px;
  margin-top: 15px;
  cursor: pointer;
}
</style>
</head>

<body>

<!-- HEADER -->
<div class="header">
  <div class="logo">TREN<span>DEALS</span></div>
  <div class="hamburger" onclick="toggleMenu()">☰</div>
</div>

<!-- SIDEBAR -->
<div class="sidebar" id="sidebar">
  <h3>Admin</h3>
  <button onclick="logout()">Logout</button>
</div>
<div class="overlay" id="overlay" onclick="toggleMenu()"></div>

<!-- MAIN -->
<div class="container">
  <div class="top-bar">
    <h2>Products</h2>
    <button class="add-btn" onclick="openModal()">+ Add Product</button>
  </div>

  <div class="products" id="products"></div>
</div>

<!-- MODAL -->
<div class="modal" id="modal">
  <div class="modal-box">
    <h3 id="modalTitle">Add Product</h3>

    <input id="name" placeholder="Product Name">
    <input id="price" placeholder="Price">
    <input id="category" placeholder="Category">
    <input id="sizes" placeholder="Sizes (S,M,L)">
    <input id="colors" placeholder="Colors (Red,Blue)">

    <label>Cover Image</label>
    <input type="file" id="coverImage">
    <div class="preview" id="coverPreview"></div>

    <label>Gallery Images</label>
    <input type="file" id="galleryImages" multiple>
    <div class="preview" id="galleryPreview"></div>

    <button class="save-btn" onclick="saveProduct()">Save Product</button>
  </div>
</div>

<script>
const SUPABASE_URL = "https://ctiglwnyimjzocvuizdq.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN0aWdsd255aW1qem9jdnVpemRxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYwNDI4MTMsImV4cCI6MjA4MTYxODgxM30.eW5nl5yCXnz0V0iya6cZCMj4Pgy05vhClUQ4pLfwYNI";
const client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let editId = null;
let galleryFiles = [];

/* MENU */
function toggleMenu() {
  sidebar.classList.toggle("active");
  overlay.classList.toggle("active");
}

/* MODAL */
function openModal(edit=false) {
  modal.classList.add("active");
  document.body.style.overflow = "hidden";
  modalTitle.textContent = edit ? "Edit Product" : "Add Product";
}
function closeModal() {
  modal.classList.remove("active");
  document.body.style.overflow = "";
}

/* IMAGE PREVIEW */
coverImage.onchange = () => {
  coverPreview.innerHTML = "";
  const img = document.createElement("img");
  img.src = URL.createObjectURL(coverImage.files[0]);
  coverPreview.appendChild(img);
};

galleryImages.onchange = () => {
  galleryPreview.innerHTML = "";
  galleryFiles = [...galleryImages.files];
  renderGallery();
};

function renderGallery() {
  galleryPreview.innerHTML = "";
  galleryFiles.forEach((f,i)=>{
    const div = document.createElement("div");
    div.innerHTML = `<img src="${URL.createObjectURL(f)}"><span onclick="removeImg(${i})">×</span>`;
    galleryPreview.appendChild(div);
  });
}
function removeImg(i){
  galleryFiles.splice(i,1);
  renderGallery();
}

async function uploadToGitHub(file) {
  const base64 = await new Promise(res => {
    const r = new FileReader();
    r.onload = () => res(r.result.split(",")[1]);
    r.readAsDataURL(file);
  });

  const res = await fetch("/api/upload", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      fileName: `${Date.now()}-${file.name}`,
      fileBase64: base64
    })
  });

  const data = await res.json();
  if (!res.ok) throw new Error(data.error);
  return data.url;
}

  
/* SAVE */
async function saveProduct() {
  const nameVal = name.value.trim();
  const priceVal = price.value.trim();
  const categoryVal = category.value.trim();

  if (!nameVal || !priceVal || !categoryVal) {
    alert("Fill all required fields");
    return;
  }

  const payload = {
    name: nameVal,
    price: Number(priceVal),
    category: categoryVal,
    sizes: sizes.value.split(",").map(s => s.trim()).filter(Boolean),
    colors: colors.value.split(",").map(c => c.trim()).filter(Boolean),
  };

  try {
    /* COVER IMAGE */
    if (coverImage.files.length) {
      payload.cover_image = await uploadToGitHub(coverImage.files[0]);
    }

    /* GALLERY IMAGES */
    if (galleryFiles.length) {
      payload.images = [];
      for (const file of galleryFiles) {
        payload.images.push(await uploadToGitHub(file));
      }
    }

    let res;
    if (editId) {
      // UPDATE
      res = await client
        .from("products")
        .update(payload)
        .eq("id", editId);
    } else {
      // INSERT
      payload.available = true;
      payload.images ||= [];
      res = await client.from("products").insert(payload);
    }

    if (res.error) throw res.error;

    /* RESET */
    editId = null;
    name.value = price.value = category.value = sizes.value = colors.value = "";
    coverImage.value = "";
    galleryImages.value = "";
    galleryFiles = [];
    coverPreview.innerHTML = "";
    galleryPreview.innerHTML = "";

    closeModal();
    loadProducts();
    alert("✅ Product saved successfully");

  } catch (err) {
    console.error("SAVE ERROR:", err);
    alert(err.message);
  }
}


/* LOGOUT */
async function logout(){
  await client.auth.signOut();
  location.reload();
}
</script>
</body>
</html>

