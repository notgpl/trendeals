<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Trendeals Admin</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="../assets/js/supabase.js"></script>

<style>
:root {
  --purple:#8e44ad;
  --bg:#faf6fb;
}

*{
  box-sizing:border-box;
  font-family:Arial, sans-serif;
  margin:0;
  padding:0
}

body{
  background:var(--bg);
}

/* ================= HEADER ================= */

.header{
  height:60px;
  background:#fff;
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:0 20px;
  box-shadow:0 2px 10px rgba(0,0,0,.05);
}

.logo{
  font-size:22px;
  font-weight:800;
}

.logo span{
  color:var(--purple)
}

.hamburger{
  width:40px;
  height:40px;
  border-radius:10px;
  background:#f2f2f2;
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
  font-size:22px;
}

.hamburger:hover{
  background:#e6e6e6;
}

/* ================= SIDEBAR ================= */

.sidebar{
  position:fixed;
  right:-260px;
  top:0;
  width:260px;
  height:100%;
  background:#fff;
  padding:20px;
  transition:.3s;
  z-index:1001;
  box-shadow:-4px 0 20px rgba(0,0,0,.1);
}

.sidebar.active{right:0}

.sidebar h3{
  margin-bottom:20px;
}

.sidebar button{
  width:100%;
  padding:10px;
  margin-bottom:10px;
  border:none;
  border-radius:8px;
  cursor:pointer;
}

.overlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.4);
  display:none;
  z-index:1000;
}

.overlay.active{display:block}

/* ================= MAIN ================= */

.container{
  padding:30px;
}

.top-bar{
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.add-btn{
  background:var(--purple);
  color:#fff;
  border:none;
  padding:12px 18px;
  border-radius:12px;
  cursor:pointer;
  font-weight:700;
}

.products{
  margin-top:25px;
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(220px,1fr));
  gap:20px;
}

/* ================= PRODUCT CARD ================= */

.card{
  background:#fff;
  border-radius:16px;
  padding:12px;
  box-shadow:0 6px 18px rgba(0,0,0,.08);
}

.card img{
  width:100%;
  height:150px;
  object-fit:cover;
  border-radius:12px;
}

.card h4{
  margin:10px 0 4px;
}

.card p{
  font-weight:700;
}

.actions{
  display:flex;
  gap:8px;
  margin-top:10px;
}

.actions button{
  flex:1;
  padding:8px;
  border:none;
  border-radius:10px;
  cursor:pointer;
  background:#f1f1f1;
  font-weight:600;
}

.actions button:hover{
  background:var(--purple);
  color:#fff;
}

/* ================= MODAL ================= */

.modal{
  position:fixed;
  inset:0;
  display:none;
  align-items:center;
  justify-content:center;
  background:rgba(0,0,0,.45);
  backdrop-filter:blur(3px);
  z-index:1002;
  pointer-events: auto;
}

.modal.active{
  display: flex;
  pointer-events: auto;
}

.modal-box{
  background:#fff;
  width:460px;
  max-width:92%;
  max-height:85vh;
  overflow-y:auto;
  border-radius:18px;
  padding:24px;
  touch-action: manipulation;
  animation:scaleIn .25s ease;
}

/* Modal Header */
.modal-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:15px;
}

.modal-header h3{
  font-size:20px;
  font-weight:700;
}

.modal-close{
  width:34px;
  height:34px;
  border-radius:50%;
  border:none;
  background:#eee;
  font-size:18px;
  cursor:pointer;
}

.modal-close:hover{
  background:#ddd;
}

/* Inputs */
.modal-box input{
  width:100%;
  padding:12px;
  margin-bottom:10px;
  border-radius:10px;
  border:1px solid #ddd;
  font-size:14px;
}

.modal-box label{
  font-size:13px;
  font-weight:600;
  margin-top:10px;
  display:block;
}

/* Image preview */
.preview{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  margin-bottom:10px;
}

.preview div{
  position:relative;
}

.preview img{
  width:70px;
  height:70px;
  object-fit:cover;
  border-radius:8px;
}

.preview span{
  position:absolute;
  top:-5px;
  right:-5px;
  background:red;
  color:#fff;
  width:18px;
  height:18px;
  border-radius:50%;
  font-size:12px;
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
}

/* Save Button */
.save-btn{
  background:var(--purple);
  color:#fff;
  width:100%;
  padding:14px;
  border:none;
  border-radius:14px;
  font-weight:700;
  font-size:15px;
  margin-top:10px;
}

@keyframes scaleIn{
  from{transform:scale(.95);opacity:0}
  to{transform:scale(1);opacity:1}
}
</style>
</head>

<body>

<div class="header">
  <div class="logo">TREN<span>DEALS</span></div>
  <div class="hamburger" onclick="toggleMenu()">☰</div>
</div>

<div class="sidebar" id="sidebar">
  <h3>Admin</h3>
  <button onclick="toggleMenu()">Close</button>
  <button onclick="logout()">Logout</button>
</div>

<div class="overlay" id="overlay" onclick="toggleMenu()"></div>

<div class="container">
  <div class="top-bar">
    <h2>Products</h2>
    <button class="add-btn" onclick="openModal()">+ Add Product</button>
  </div>

  <div class="products" id="products"></div>
</div>

<!-- ================= MODAL ================= -->

<div class="modal" id="modal">
  <div class="modal-box" onclick="event.stopPropagation()">

    <div class="modal-header">
      <h3 id="modalTitle">Add Product</h3>
      <button class="modal-close" onclick="closeModal()">✕</button>
    </div>

    <input id="name" placeholder="Product Name">
    <input id="price" placeholder="Price">
    <input id="category" placeholder="Category">
    <input id="sizes" placeholder="Sizes (S,M,L)">
    <input id="colors" placeholder="Colors (Red,Blue)">

    <label>Cover Image</label>
    <input type="file" id="coverImage">
    <div class="preview" id="coverPreview"></div>

    <label>Gallery Images</label>
    <input type="file" id="galleryImages" multiple>
    <div class="preview" id="galleryPreview"></div>

   <button type="button" class="save-btn" onclick="saveProduct()">
  Save Product
</button>

  </div>
</div>

<script>
const client = window.supabaseClient;

let editId=null;
let galleryFiles=[];

function toggleMenu(){
  sidebar.classList.toggle("active");
  overlay.classList.toggle("active");
}

function openModal(edit=false){
  modal.classList.add("active");
  document.body.style.overflow = "hidden";
  modalTitle.textContent = edit ? "Edit Product" : "Add Product";
}

function closeModal(){
  modal.classList.remove("active");
  document.body.style.overflow = "";
  editId = null;
  galleryFiles = [];
  coverPreview.innerHTML = "";
  galleryPreview.innerHTML = "";
}

coverImage.onchange=()=>{
  coverPreview.innerHTML="";
  const img=document.createElement("img");
  img.src=URL.createObjectURL(coverImage.files[0]);
  coverPreview.appendChild(img);
};

galleryImages.onchange=()=>{
  galleryFiles=[...galleryImages.files];
  renderGallery();
};

function renderGallery(){
  galleryPreview.innerHTML="";
  galleryFiles.forEach((f,i)=>{
    galleryPreview.innerHTML+=`
      <div>
        <img src="${URL.createObjectURL(f)}">
        <span onclick="removeImg(${i})">×</span>
      </div>`;
  });
}

function removeImg(i){
  galleryFiles.splice(i,1);
  renderGallery();
}

async function uploadToGitHub(file){
  const base64=await new Promise(res=>{
    const r=new FileReader();
    r.onload=()=>res(r.result.split(",")[1]);
    r.readAsDataURL(file);
  });

  const r=await fetch("/api/upload",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({
      fileName:Date.now()+"-"+file.name,
      fileBase64:base64
    })
  });

  const d=await r.json();
  if(!r.ok) throw d.error;
  return d.url;
}

async function saveProduct() {
  try {
    const nameEl = document.getElementById("name");
    const priceEl = document.getElementById("price");
    const categoryEl = document.getElementById("category");
    const sizesEl = document.getElementById("sizes");
    const colorsEl = document.getElementById("colors");

    const payload = {
      name: nameEl.value?.trim() || "",
      price: Number(priceEl.value),
      category: categoryEl.value?.trim() || "",
      sizes: sizesEl.value
        ? sizesEl.value.split(",").map(s => s.trim()).filter(Boolean)
        : [],
      colors: colorsEl.value
        ? colorsEl.value.split(",").map(c => c.trim()).filter(Boolean)
        : [],
    };

    if (!payload.name || !payload.price || !payload.category) {
      alert("Fill required fields");
      return;
    }

    if (coverImage.files && coverImage.files.length > 0) {
  payload.cover_image = await uploadToGitHub(coverImage.files[0]);
}

    if (galleryFiles.length) {
      payload.images = [];
      for (const f of galleryFiles) {
        payload.images.push(await uploadToGitHub(f));
      }
    }

    if (editId) {
      await client.from("products").update(payload).eq("id", editId);
    } else {
      payload.available = true;
      payload.images ||= [];
      await client.from("products").insert(payload);
    }

    await loadProducts();
    closeModal();


  } catch (err) {
    console.error("Save failed:", err);
    alert("Something went wrong while saving. Check console.");
  }
}


async function loadProducts() {
  try {
    const { data, error } = await client
      .from("products")
      .select("*")
      .order("created_at", { ascending: false });

    if (error) throw error;

    products.innerHTML = "";

    data.forEach(p => {
      products.innerHTML += `
        <div class="card">
          <img src="${p.cover_image || ""}">
          <h4>${p.name}</h4>
          <p>₹${p.price}</p>
          <div class="actions">
            <button onclick="editProduct('${p.id}')">Edit</button>
            <button onclick="deleteProduct('${p.id}')">Delete</button>
          </div>
        </div>`;
    });

  } catch (err) {
    console.error("Load failed:", err);
    alert("Failed to load products");
  }
}


async function editProduct(id){
  const {data}=await client.from("products").select("*").eq("id",id).single();
  editId=id;
  name.value=data.name;
  price.value=data.price;
  category.value=data.category;
  sizes.value=(data.sizes||[]).join(",");
  colors.value=(data.colors||[]).join(",");
  openModal(true);
}

async function deleteProduct(id){
  if(confirm("Delete product?")){
    await client.from("products").delete().eq("id",id);
    loadProducts();
  }
}

async function logout(){
  await client.auth.signOut();
  location.reload();
}

loadProducts();

document.getElementById("modal").addEventListener("click", e => {
  if (e.target.id === "modal") {
    closeModal();
  }
});

</script>

</body>
</html>







