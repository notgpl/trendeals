<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Trendeals Admin</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root {
  --purple:#8e44ad;
  --bg:#faf6fb;
}
*{box-sizing:border-box;font-family:Arial;margin:0;padding:0}
body{background:var(--bg)}

.header{
  height:60px;background:#fff;display:flex;align-items:center;
  justify-content:space-between;padding:0 20px;
}
.logo{font-size:22px;font-weight:800}
.logo span{color:var(--purple)}
.hamburger{font-size:26px;cursor:pointer}

.sidebar{
  position:fixed;right:-260px;top:0;width:260px;height:100%;
  background:#fff;padding:20px;transition:.3s;z-index:1001;
}
.sidebar.active{right:0}
.overlay{
  position:fixed;inset:0;background:rgba(0,0,0,.4);
  display:none;z-index:1000;
}
.overlay.active{display:block}

.container{padding:30px}
.top-bar{display:flex;justify-content:space-between;align-items:center}
.add-btn{
  background:var(--purple);color:#fff;border:none;
  padding:12px 18px;border-radius:10px;cursor:pointer;
}

.products{
  margin-top:25px;
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(220px,1fr));
  gap:20px;
}
.card{
  background:#fff;border-radius:14px;padding:12px;
}
.card img{width:100%;height:150px;object-fit:cover;border-radius:10px}
.card h4{margin:8px 0}
.actions{display:flex;gap:8px}
.actions button{flex:1;padding:8px;border:none;border-radius:8px}

.modal{
  position:fixed;inset:0;display:none;
  align-items:center;justify-content:center;z-index:1002;
}
.modal.active{display:flex}
.modal-box{
  background:#fff;width:420px;
  max-height:85vh;overflow-y:auto;
  border-radius:16px;padding:20px;
}
.modal-box input{width:100%;padding:10px;margin-bottom:10px}
.preview{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px}
.preview div{position:relative}
.preview img{width:70px;height:70px;object-fit:cover;border-radius:8px}
.preview span{
  position:absolute;top:-5px;right:-5px;
  background:red;color:#fff;width:18px;height:18px;
  border-radius:50%;font-size:12px;
  display:flex;align-items:center;justify-content:center;
  cursor:pointer;
}
.save-btn{
  background:var(--purple);color:#fff;
  width:100%;padding:12px;border:none;border-radius:10px;
}
</style>
</head>

<body>

<div class="header">
  <div class="logo">TREN<span>DEALS</span></div>
  <div class="hamburger" onclick="toggleMenu()">☰</div>
</div>

<div class="sidebar" id="sidebar">
  <h3>Admin</h3>
  <button onclick="toggleMenu()">Close</button><br><br>
  <button onclick="logout()">Logout</button>
</div>
<div class="overlay" id="overlay" onclick="toggleMenu()"></div>

<div class="container">
  <div class="top-bar">
    <h2>Products</h2>
    <button class="add-btn" onclick="openModal()">+ Add Product</button>
  </div>
  <div class="products" id="products"></div>
</div>

<div class="modal" id="modal" onclick="closeModal(event)">
  <div class="modal-box" onclick="event.stopPropagation()">
    <h3 id="modalTitle">Add Product</h3>

    <input id="name" placeholder="Product Name">
    <input id="price" placeholder="Price">
    <input id="category" placeholder="Category">
    <input id="sizes" placeholder="Sizes (S,M,L)">
    <input id="colors" placeholder="Colors (Red,Blue)">

    <label>Cover Image</label>
    <input type="file" id="coverImage">
    <div class="preview" id="coverPreview"></div>

    <label>Gallery Images</label>
    <input type="file" id="galleryImages" multiple>
    <div class="preview" id="galleryPreview"></div>

    <button class="save-btn" onclick="saveProduct()">Save Product</button>
  </div>
</div>

<script>
const SUPABASE_URL="https://ctiglwnyimjzocvuizdq.supabase.co";
const SUPABASE_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN0aWdsd255aW1qem9jdnVpemRxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYwNDI4MTMsImV4cCI6MjA4MTYxODgxM30.eW5nl5yCXnz0V0iya6cZCMj4Pgy05vhClUQ4pLfwYNI";
const client=supabase.createClient(SUPABASE_URL,SUPABASE_KEY);

let editId=null;
let galleryFiles=[];

function toggleMenu(){
  sidebar.classList.toggle("active");
  overlay.classList.toggle("active");
}
function openModal(edit=false){
  modal.classList.add("active");
  modalTitle.textContent=edit?"Edit Product":"Add Product";
}
function closeModal(e){
  modal.classList.remove("active");
}

coverImage.onchange=()=>{
  coverPreview.innerHTML="";
  const img=document.createElement("img");
  img.src=URL.createObjectURL(coverImage.files[0]);
  coverPreview.appendChild(img);
};

galleryImages.onchange=()=>{
  galleryFiles=[...galleryImages.files];
  renderGallery();
};
function renderGallery(){
  galleryPreview.innerHTML="";
  galleryFiles.forEach((f,i)=>{
    galleryPreview.innerHTML+=`
      <div><img src="${URL.createObjectURL(f)}">
      <span onclick="removeImg(${i})">×</span></div>`;
  });
}
function removeImg(i){
  galleryFiles.splice(i,1);
  renderGallery();
}

async function uploadToGitHub(file){
  const base64=await new Promise(res=>{
    const r=new FileReader();
    r.onload=()=>res(r.result.split(",")[1]);
    r.readAsDataURL(file);
  });
  const r=await fetch("/api/upload",{method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({fileName:Date.now()+"-"+file.name,fileBase64:base64})
  });
  const d=await r.json(); if(!r.ok)throw d.error; return d.url;
}

async function saveProduct(){
  const nameEl=document.getElementById("name");
  const priceEl=document.getElementById("price");
  const categoryEl=document.getElementById("category");
  const sizesEl=document.getElementById("sizes");
  const colorsEl=document.getElementById("colors");

  const payload={
    name:nameEl.value.trim(),
    price:Number(priceEl.value),
    category:categoryEl.value.trim(),
    sizes:sizesEl.value.split(",").map(s=>s.trim()).filter(Boolean),
    colors:colorsEl.value.split(",").map(c=>c.trim()).filter(Boolean),
  };

  if(!payload.name||!payload.price||!payload.category){
    alert("Fill required fields");return;
  }

  if(coverImage.files[0])
    payload.cover_image=await uploadToGitHub(coverImage.files[0]);

  if(galleryFiles.length){
    payload.images=[];
    for(const f of galleryFiles)
      payload.images.push(await uploadToGitHub(f));
  }

  if(editId)
    await client.from("products").update(payload).eq("id",editId);
  else{
    payload.available=true;
    payload.images ||= [];
    await client.from("products").insert(payload);
  }

  closeModal();
  loadProducts();
}

async function loadProducts(){
  const {data}=await client.from("products").select("*");
  products.innerHTML="";
  data.forEach(p=>{
    products.innerHTML+=`
    <div class="card">
      <img src="${p.cover_image}">
      <h4>${p.name}</h4>
      <p>₹${p.price}</p>
      <div class="actions">
        <button onclick="editProduct('${p.id}')">Edit</button>
        <button onclick="deleteProduct('${p.id}')">Delete</button>
      </div>
    </div>`;
  });
}

async function editProduct(id){
  const {data}=await client.from("products").select("*").eq("id",id).single();
  editId=id;
  name.value=data.name;
  price.value=data.price;
  category.value=data.category;
  sizes.value=(data.sizes||[]).join(",");
  colors.value=(data.colors||[]).join(",");
  openModal(true);
}

async function deleteProduct(id){
  if(confirm("Delete product?")){
    await client.from("products").delete().eq("id",id);
    loadProducts();
  }
}

async function logout(){
  await client.auth.signOut();
  location.reload();
}

loadProducts();
</script>
</body>
</html>
