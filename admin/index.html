<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Trendeals Admin</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="../assets/js/supabase.js"></script>

<style>
/* üîí ALL YOUR ORIGINAL CSS ‚Äî UNCHANGED */
:root { --purple:#8e44ad; --bg:#faf6fb; }
*{ box-sizing:border-box; font-family:Arial, sans-serif; margin:0; padding:0 }
body{ background:var(--bg); }

/* ===== MODAL BACKDROP ===== */
.modal {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.55);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 3000;
}

.modal.active {
  display: flex;
}

/* ===== MODAL BOX ===== */
.modal-box {
  background: #fff;
  width: 480px;
  max-width: 94%;
  max-height: 85vh;
  border-radius: 20px;
  box-shadow: 0 25px 60px rgba(0,0,0,.25);
  display: flex;
  flex-direction: column;
  overflow: hidden;
  animation: modalPop .25s ease;
}

/* ===== HEADER ===== */
.modal-header {
  padding: 16px 20px;
  border-bottom: 1px solid #eee;
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.modal-header h3 {
  font-size: 18px;
  font-weight: 700;
}

/* ‚ùå */
.modal-close {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  border: none;
  background: #f2f2f2;
  font-size: 18px;
  cursor: pointer;
}

.modal-close:hover {
  background: #e0e0e0;
}

/* ===== BODY ===== */
.modal-body {
  padding: 20px;
  overflow-y: auto;
}

/* INPUTS */
.modal-body input {
  width: 100%;
  padding: 12px 14px;
  border-radius: 12px;
  border: 1px solid #ddd;
  margin-bottom: 12px;
  font-size: 14px;
}

.modal-body input:focus {
  outline: none;
  border-color: #8e44ad;
}

/* LABELS */
.modal-body label {
  font-size: 13px;
  font-weight: 600;
  margin: 12px 0 6px;
  display: block;
}

/* IMAGE PREVIEW */
.preview {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
  margin-bottom: 10px;
}

.preview img {
  width: 70px;
  height: 70px;
  object-fit: cover;
  border-radius: 10px;
  border: 1px solid #ddd;
}

/* SAVE BUTTON */
.save-btn {
  margin-top: 15px;
  background: linear-gradient(135deg,#8e44ad,#9b59b6);
  color: #fff;
  border: none;
  padding: 14px;
  border-radius: 14px;
  font-weight: 700;
  font-size: 15px;
  cursor: pointer;
}

.save-btn:hover {
  opacity: .95;
}

/* ===== ANIMATION ===== */
@keyframes modalPop {
  from {
    transform: scale(.96);
    opacity: 0;
  }
  to {
    transform: scale(1);
    opacity: 1;
  }
}



/* header */
.header{height:60px;background:#fff;display:flex;align-items:center;justify-content:space-between;padding:0 20px;box-shadow:0 2px 10px rgba(0,0,0,.05)}
.logo{font-size:22px;font-weight:800}
.logo span{color:var(--purple)}
.hamburger{width:40px;height:40px;border-radius:10px;background:#f2f2f2;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:22px}
/* sidebar */
.sidebar{position:fixed;right:-260px;top:0;width:260px;height:100%;background:#fff;padding:20px;transition:.3s;z-index:1001}
.sidebar.active{right:0}
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;z-index:1000}
.overlay.active{display:block}
/* main */
.container{padding:30px}
.top-bar{display:flex;justify-content:space-between;align-items:center}
.add-btn{background:var(--purple);color:#fff;border:none;padding:12px 18px;border-radius:12px;font-weight:700}
.products{margin-top:25px;display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:20px}
/* card */
.card{background:#fff;border-radius:16px;padding:12px;box-shadow:0 6px 18px rgba(0,0,0,.08)}
.card img{width:100%;height:150px;object-fit:cover;border-radius:12px}
.actions{display:flex;gap:8px;margin-top:10px}

/* login overlay */
#loginOverlay{position:fixed;inset:0;background:rgba(0,0,0,.45);display:flex;align-items:center;justify-content:center;z-index:5000}
</style>
</head>

<body>

<!-- LOGIN OVERLAY -->
<div id="loginOverlay">
  <div style="background:#fff;width:360px;padding:24px;border-radius:16px">
    <h2 style="text-align:center;margin-bottom:15px">Admin Login</h2>
    <input id="adminEmail" placeholder="Email" style="width:100%;padding:12px;margin-bottom:10px">
    <input id="adminPassword" type="password" placeholder="Password" style="width:100%;padding:12px;margin-bottom:15px">
    <button onclick="adminLogin()" style="width:100%;padding:12px;background:#8e44ad;color:#fff;border:none;border-radius:10px;font-weight:700">Login</button>
    <p id="loginError" style="color:red;text-align:center;margin-top:10px"></p>
  </div>
</div>

<!-- ADMIN UI -->
<div id="adminApp" style="display:none">

<div class="header">
  <div class="logo">TREN<span>DEALS</span></div>
  <div class="hamburger" onclick="toggleMenu()">‚ò∞</div>
</div>

<div class="sidebar" id="sidebar">
  <button onclick="toggleMenu()">Close</button>
  <button onclick="logout()">Logout</button>
</div>

<div class="overlay" id="overlay" onclick="toggleMenu()"></div>

<div class="container">
  <div class="top-bar">
    <h2>Products</h2>
    <button class="add-btn" onclick="openModal()">+ Add Product</button>
  </div>
  <div class="products" id="products"></div>
</div>

<div class="modal-box">
  <div class="modal-header">
    <h3 id="modalTitle">Add Product</h3>
    <button class="modal-close" onclick="closeModal()">‚úï</button>
  </div>

  <div class="modal-body">
    <input id="name" placeholder="Product Name">
    <input id="price" type="number" placeholder="Price">
    <input id="category" placeholder="Category">
    <input id="sizes" placeholder="Sizes (S,M,L)">
    <input id="colors" placeholder="Colors (Red,Blue)">

    <label>Cover Image</label>
    <input type="file" id="coverImage">
    <div class="preview" id="coverPreview"></div>

    <label>Gallery Images</label>
    <input type="file" id="galleryImages" multiple>
    <div class="preview" id="galleryPreview"></div>

    <button class="save-btn" onclick="saveProduct()">Save Product</button>
  </div>
</div>


</div>

<script>
const client = window.supabaseClient;

document.addEventListener("DOMContentLoaded", checkAdminSession);

async function checkAdminSession(){
  const { data } = await client.auth.getSession();
  if(data.session){
    loginOverlay.style.display="none";
    adminApp.style.display="block";
    loadProducts();
  }else{
    loginOverlay.style.display="flex";
    adminApp.style.display="none";
  }
}

async function adminLogin(){
  const email = adminEmail.value.trim();
  const password = adminPassword.value.trim();

  const { error } = await client.auth.signInWithPassword({ email, password });
  if(error){
    loginError.textContent = error.message;
    return;
  }
  checkAdminSession();
}

async function logout(){
  await client.auth.signOut();
  location.reload();
}

function toggleMenu(){
  sidebar.classList.toggle("active");
  overlay.classList.toggle("active");
}

function openModal(){ modal.classList.add("active"); }
function closeModal(){ modal.classList.remove("active"); }

async function loadProducts(){
  const { data } = await client
    .from("products")
    .select("*")
    .order("created_at",{ascending:false});

  products.innerHTML = "";

  data?.forEach(p => {
  products.innerHTML += `
  <div class="card">
    <img src="${p.cover_image || ""}">
    <h4>${p.name}</h4>
    <p>‚Çπ${p.price}</p>
    <div class="actions">
      <button onclick="editProduct('${p.id}')">Edit</button>
      <button onclick="deleteProduct('${p.id}')">Delete</button>
    </div>
  </div>
`;
  });
}

  async function deleteProduct(id){
  if (!confirm("Delete product?")) return;
  await client.from("products").delete().eq("id", id);
  loadProducts();
}

async function toggleAvailable(id, current) {
  const { error } = await client
    .from("products")
    .update({ available: !current })
    .eq("id", id);

  if (error) {
    console.error("Toggle failed:", error);
    alert("Failed to update status");
    return;
  }

  loadProducts();
}



async function uploadToGitHub(file) {
  const base64 = await new Promise(res => {
    const reader = new FileReader();
    reader.onload = () => res(reader.result.split(",")[1]);
    reader.readAsDataURL(file);
  });

  const res = await fetch("/api/upload", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      fileName: Date.now() + "-" + file.name,
      fileBase64: base64
    })
  });

  const data = await res.json();
  if (!res.ok) throw data.error;
  return data.url;
}
  
async function saveProduct() {
  try {
    // ‚úÖ EXPLICIT INPUT REFERENCES (THIS FIXES THE ERROR)
    const nameInput = document.getElementById("name");
    const priceInput = document.getElementById("price");
    const categoryInput = document.getElementById("category");
    const sizesInput = document.getElementById("sizes");
    const colorsInput = document.getElementById("colors");

    const nameValue = nameInput.value.trim();
    const categoryValue = categoryInput.value.trim();
    const priceValue = priceInput.value.trim();

    // ‚úÖ VALIDATION
    if (!nameValue || !categoryValue || priceValue === "" || Number(priceValue) <= 0) {
      alert("Fill required fields");
      return;
    }

    // ‚úÖ IMAGE UPLOAD
    let coverUrl = null;
    let galleryUrls = [];

    if (coverImage.files.length > 0) {
      coverUrl = await uploadToGitHub(coverImage.files[0]);
    }

    if (galleryImages.files.length > 0) {
      for (const file of galleryImages.files) {
        galleryUrls.push(await uploadToGitHub(file));
      }
    }

    const payload = {
      name: nameValue,
      price: Number(priceValue),
      category: categoryValue,
      sizes: sizesInput.value
        ? sizesInput.value.split(",").map(s => s.trim())
        : [],
      colors: colorsInput.value
        ? colorsInput.value.split(",").map(c => c.trim())
        : [],
      cover_image: coverUrl,
      images: galleryUrls,   // ‚ö†Ô∏è REQUIRED (NOT NULL)
      available: true
    };

    let error;

if (editId) {
  await client.from("products").update(payload).eq("id", editId);
  editId = null;
} else {
  await client.from("products").insert(payload);
}

if (error) throw error;


    closeModal();
    loadProducts();

  } catch (err) {
    console.error("Save failed:", err);
    alert("Save failed ‚Äî check console");
  }
}


let editId = null;

async function editProduct(id) {
  editId = id;

  const { data, error } = await client
    .from("products")
    .select("*")
    .eq("id", id)
    .single();

  if (error) {
    alert("Failed to load product");
    return;
  }

  document.getElementById("name").value = data.name || "";
  document.getElementById("price").value = data.price || "";
  document.getElementById("category").value = data.category || "";
  document.getElementById("sizes").value = (data.sizes || []).join(",");
  document.getElementById("colors").value = (data.colors || []).join(",");

  // Cover preview
  document.getElementById("coverPreview").innerHTML = data.cover_image
    ? `<img src="${data.cover_image}">`
    : "";

  // Gallery preview
  document.getElementById("galleryPreview").innerHTML = (data.images || [])
    .map(img => `<img src="${img}">`)
    .join("");

  openModal();
}


  document.addEventListener("DOMContentLoaded", () => {
  modal.classList.remove("active");
});



</script>

  

</body>
</html>

















