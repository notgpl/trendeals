<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Trendeals Admin</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body {
  font-family: Arial, sans-serif;
  background: #f4f6f8;
  max-width: 600px;
  margin: auto;
  padding: 15px;
}

button {
  padding: 10px;
  width: 100%;
  cursor: pointer;
}

input {
  width: 100%;
  padding: 10px;
  margin: 6px 0;
}

.hidden { display: none; }

/* HEADER */
.header {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

/* PRODUCT CARD */
.product {
  background: #fff;
  border-radius: 8px;
  padding: 12px;
  margin-top: 10px;
  box-shadow: 0 2px 6px rgba(0,0,0,.08);
}

/* MODAL */
.modal {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.5);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 1000;
}

.modal.active { display: flex; }

.modal-box {
  background: #fff;
  width: 100%;
  max-width: 500px;
  border-radius: 10px;
  padding: 15px;
  max-height: 90vh;
  overflow-y: auto;
}

/* IMAGE PREVIEW */
.preview {
  margin-top: 8px;
}

.preview img {
  width: 100%;
  border-radius: 6px;
}

.gallery {
  display: grid;
  grid-template-columns: repeat(3,1fr);
  gap: 8px;
  margin-top: 8px;
}

.gallery div {
  position: relative;
}

.gallery img {
  width: 100%;
  border-radius: 6px;
}

.gallery span {
  position: absolute;
  top: 2px;
  right: 2px;
  background: red;
  color: #fff;
  font-size: 12px;
  padding: 2px 6px;
  border-radius: 50%;
  cursor: pointer;
}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="loginBox">
  <h2>Admin Login</h2>
  <input id="email" placeholder="Email">
  <input id="password" type="password">
  <button onclick="login()">Login</button>
</div>

<!-- PANEL -->
<div id="panel" class="hidden">

  <div class="header">
    <h2>Products</h2>
    <button onclick="openModal()">➕ Add Product</button>
  </div>

  <button onclick="logout()">Logout</button>

  <div id="products"></div>
</div>

<!-- MODAL -->
<div class="modal" id="productModal">
  <div class="modal-box">
    <h3 id="modalTitle">Add Product</h3>

    <input type="hidden" id="editId">

    <input id="p_name" placeholder="Product name">
    <input id="p_price" placeholder="Price">
    <input id="p_category" placeholder="Category">
    <input id="p_sizes" placeholder="Sizes (S,M,L)">
    <input id="p_colors" placeholder="Colors (Red,Blue)">

    <label>Cover Image</label>
    <input type="file" id="coverImage" accept="image/*">
    <div class="preview" id="coverPreview"></div>

    <label>Gallery Images</label>
    <input type="file" id="galleryImages" accept="image/*" multiple>
    <div class="gallery" id="galleryPreview"></div>

    <button onclick="saveProduct()">Save</button>
    <button onclick="closeModal()">Cancel</button>
  </div>
</div>

<script>
const SUPABASE_URL = "https://ctiglwnyimjzocvuizdq.supabase.co";
const SUPABASE_KEY = "YOUR_ANON_KEY";
const client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let galleryFiles = [];

/* AUTH */
async function login() {
  const { error } = await client.auth.signInWithPassword({
    email: email.value,
    password: password.value
  });
  if (error) return alert(error.message);
  loginBox.classList.add("hidden");
  panel.classList.remove("hidden");
  loadProducts();
}

async function logout() {
  await client.auth.signOut();
  location.reload();
}

/* MODAL */
function openModal(edit=false) {
  productModal.classList.add("active");
  modalTitle.textContent = edit ? "Edit Product" : "Add Product";
}

function closeModal() {
  productModal.classList.remove("active");
  document.querySelectorAll("input").forEach(i => i.value = "");
  coverPreview.innerHTML = "";
  galleryPreview.innerHTML = "";
  galleryFiles = [];
  editId.value = "";
}

/* IMAGE PREVIEW */
coverImage.onchange = () => {
  coverPreview.innerHTML = `<img src="${URL.createObjectURL(coverImage.files[0])}">`;
};

galleryImages.onchange = () => {
  for (const f of galleryImages.files) {
    galleryFiles.push(f);
  }
  renderGallery();
};

function renderGallery() {
  galleryPreview.innerHTML = "";
  galleryFiles.forEach((f,i) => {
    galleryPreview.innerHTML += `
      <div>
        <img src="${URL.createObjectURL(f)}">
        <span onclick="removeGallery(${i})">×</span>
      </div>
    `;
  });
}

function removeGallery(i) {
  galleryFiles.splice(i,1);
  renderGallery();
}

/* LOAD PRODUCTS */
async function loadProducts() {
  const { data } = await client.from("products").select("*").order("created_at",{ascending:false});
  products.innerHTML = "";
  data.forEach(p => {
    products.innerHTML += `
      <div class="product">
        <b>${p.name}</b> – ₹${p.price}<br><br>
        <button onclick="editProduct('${p.id}')">Edit</button>
        <button onclick="toggleAvailability('${p.id}',${!p.available})">
          ${p.available ? "Disable":"Enable"}
        </button>
        <button onclick="removeProduct('${p.id}')">Delete</button>
      </div>
    `;
  });
}

/* EDIT */
async function editProduct(id) {
  const { data } = await client.from("products").select("*").eq("id",id).single();

  editId.value = id;
  p_name.value = data.name;
  p_price.value = data.price;
  p_category.value = data.category;
  p_sizes.value = (data.sizes||[]).join(",");
  p_colors.value = (data.colors||[]).join(",");

  openModal(true);
}

/* SAVE */
async function saveProduct() {
  const payload = {
    name: p_name.value.trim(),
    price: Number(p_price.value),
    category: p_category.value.trim(),
    sizes: p_sizes.value.split(",").map(s=>s.trim()).filter(Boolean),
    colors: p_colors.value.split(",").map(c=>c.trim()).filter(Boolean),
    available: true
  };

  if (!payload.name || !payload.price || !payload.category) {
    alert("Fill all fields");
    return;
  }

  // ⚠️ GitHub upload placeholder (same API you already built)
  // payload.cover_image = await uploadToGitHub(...)
  // payload.images = [...]

  if (editId.value) {
    await client.from("products").update(payload).eq("id",editId.value);
  } else {
    await client.from("products").insert(payload);
  }

  closeModal();
  loadProducts();
}

/* TOGGLE & DELETE */
async function toggleAvailability(id,state){
  await client.from("products").update({available:state}).eq("id",id);
  loadProducts();
}

async function removeProduct(id){
  if(confirm("Delete product?")){
    await client.from("products").delete().eq("id",id);
    loadProducts();
  }
}
</script>
</body>
</html>
